{"type":"text","lines":["<!DOCTYPE html>","<html lang=\"en\">","<head>","  <meta charset=\"UTF-8\">","  <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">","  <title>Encantis IDE</title>","  <style>","    * { margin: 0; padding: 0; box-sizing: border-box; }","    ","    :root {","      --bg-dark: #1e1e2e;","      --bg-darker: #181825;","      --bg-lighter: #313244;","      --border: #45475a;","      --text: #cdd6f4;","      --text-dim: #6c7086;","      --accent: #89b4fa;","      --accent2: #f5c2e7;","      --green: #a6e3a1;","      --red: #f38ba8;","      --yellow: #f9e2af;","      --purple: #cba6f7;","      --orange: #fab387;","      --cyan: #94e2d5;","    }","    ","    body {","      font-family: system-ui, -apple-system, sans-serif;","      background: var(--bg-dark);","      color: var(--text);","      height: 100vh;","      display: flex;","      flex-direction: column;","      overflow: hidden;","    }","    ","    /* Header */","    header {","      background: var(--bg-darker);","      padding: 0.5rem 1rem;","      border-bottom: 1px solid var(--border);","      display: flex;","      align-items: center;","      gap: 1rem;","    }","    ","    .logo {","      font-size: 1.2rem;","      font-weight: bold;","      color: var(--accent);","      display: flex;","      align-items: center;","      gap: 0.5rem;","    }","    ","    .logo-icon {","      font-size: 1.5rem;","    }","    ","    .toolbar {","      display: flex;","      gap: 0.5rem;","      margin-left: auto;","    }","    ","    .toolbar-btn {","      background: var(--bg-lighter);","      border: 1px solid var(--border);","      color: var(--text);","      padding: 0.4rem 0.8rem;","      border-radius: 4px;","      cursor: pointer;","      font-size: 0.8rem;","      display: flex;","      align-items: center;","      gap: 0.3rem;","    }","    ","    .toolbar-btn:hover {","      background: var(--border);","    }","    ","    .toolbar-btn.primary {","      background: var(--accent);","      color: var(--bg-darker);","      border-color: var(--accent);","    }","    ","    .toolbar-btn.primary:hover {","      opacity: 0.9;","    }","    ","    /* Main Layout */","    .main-container {","      flex: 1;","      display: flex;","      overflow: hidden;","    }","    ","    /* Sidebar */","    .sidebar {","      width: 250px;","      background: var(--bg-darker);","      border-right: 1px solid var(--border);","      display: flex;","      flex-direction: column;","    }","    ","    .sidebar-header {","      padding: 0.75rem 1rem;","      font-size: 0.75rem;","      text-transform: uppercase;","      color: var(--text-dim);","      border-bottom: 1px solid var(--border);","      display: flex;","      justify-content: space-between;","      align-items: center;","    }","    ","    .sidebar-header button {","      background: none;","      border: none;","      color: var(--text-dim);","      cursor: pointer;","      font-size: 1rem;","      padding: 0.2rem;","    }","    ","    .sidebar-header button:hover {","      color: var(--text);","    }","    ","    .file-tree {","      flex: 1;","      overflow-y: auto;","      padding: 0.5rem 0;","    }","    ","    .file-item {","      padding: 0.4rem 1rem;","      cursor: pointer;","      display: flex;","      align-items: center;","      gap: 0.5rem;","      font-size: 0.85rem;","    }","    ","    .file-item:hover {","      background: var(--bg-lighter);","    }","    ","    .file-item.active {","      background: var(--bg-lighter);","      border-left: 2px solid var(--accent);","    }","    ","    .file-item.folder {","      color: var(--yellow);","    }","    ","    .file-item.file {","      color: var(--text);","    }","    ","    .file-icon {","      font-size: 1rem;","    }","    ","    .file-name {","      flex: 1;","      overflow: hidden;","      text-overflow: ellipsis;","      white-space: nowrap;","    }","    ","    .file-actions {","      display: none;","      gap: 0.25rem;","    }","    ","    .file-item:hover .file-actions {","      display: flex;","    }","    ","    .file-action {","      background: none;","      border: none;","      color: var(--text-dim);","      cursor: pointer;","      font-size: 0.8rem;","      padding: 0.1rem 0.3rem;","    }","    ","    .file-action:hover {","      color: var(--red);","    }","    ","    /* Editor Area */","    .editor-area {","      flex: 1;","      display: flex;","      flex-direction: column;","      min-width: 0;","    }","    ","    /* Tabs */","    .tabs {","      background: var(--bg-darker);","      display: flex;","      border-bottom: 1px solid var(--border);","      overflow-x: auto;","    }","    ","    .tab {","      padding: 0.6rem 1rem;","      background: transparent;","      border: none;","      color: var(--text-dim);","      cursor: pointer;","      font-size: 0.85rem;","      display: flex;","      align-items: center;","      gap: 0.5rem;","      border-bottom: 2px solid transparent;","      white-space: nowrap;","    }","    ","    .tab:hover {","      background: var(--bg-lighter);","    }","    ","    .tab.active {","      color: var(--text);","      border-bottom-color: var(--accent);","      background: var(--bg-dark);","    }","    ","    .tab-close {","      font-size: 0.9rem;","      opacity: 0.5;","      padding: 0.1rem 0.2rem;","      border-radius: 3px;","    }","    ","    .tab-close:hover {","      opacity: 1;","      background: var(--red);","      color: white;","    }","    ","    .tab-modified {","      width: 8px;","      height: 8px;","      background: var(--yellow);","      border-radius: 50%;","    }","    ","    /* Editor */","    .editor-container {","      flex: 1;","      display: flex;","      overflow: hidden;","    }","    ","    .line-numbers {","      background: var(--bg-darker);","      color: var(--text-dim);","      padding: 1rem 0.5rem;","      text-align: right;","      font-family: 'Monaco', 'Menlo', monospace;","      font-size: 14px;","      line-height: 1.6;","      user-select: none;","      border-right: 1px solid var(--border);","      min-width: 50px;","    }","    ","    .editor-wrapper {","      flex: 1;","      position: relative;","      overflow: hidden;","    }","    ","    .editor {","      position: absolute;","      top: 0;","      left: 0;","      right: 0;","      bottom: 0;","      background: transparent;","      color: transparent;","      caret-color: var(--text);","      border: none;","      padding: 1rem;","      font-family: 'Monaco', 'Menlo', monospace;","      font-size: 14px;","      line-height: 1.6;","      resize: none;","      overflow: auto;","      white-space: pre;","      tab-size: 2;","      z-index: 1;","    }","    .editor:focus {","      outline: none;","    }","    ","    .syntax-highlight {","      position: absolute;","      top: 0;","      left: 0;","      right: 0;","      bottom: 0;","      padding: 1rem;","      font-family: 'Monaco', 'Menlo', monospace;","      font-size: 14px;","      line-height: 1.6;","      pointer-events: none;","      white-space: pre;","      overflow: hidden;","      color: transparent;","      color: var(--text);","    }","    ","    /* Syntax highlighting colors */","    .hl-comment { color: var(--text-dim); font-style: italic; }","    .hl-string { color: var(--green); }","    .hl-keyword { color: var(--purple); font-weight: 500; }","    .hl-type { color: var(--yellow); }","    .hl-constant { color: var(--orange); }","    .hl-number { color: var(--orange); }","    .hl-operator { color: var(--cyan); }","    .hl-punctuation { color: var(--text-dim); }","    .hl-function { color: var(--accent); }","    }","    ","    /* Output Panel */","    .output-panel {","      height: 200px;","      background: var(--bg-darker);","      border-top: 1px solid var(--border);","      display: flex;","      flex-direction: column;","    }","    ","    .output-tabs {","      display: flex;","      border-bottom: 1px solid var(--border);","    }","    ","    .output-tab {","      padding: 0.5rem 1rem;","      background: transparent;","      border: none;","      color: var(--text-dim);","      cursor: pointer;","      font-size: 0.8rem;","      border-bottom: 2px solid transparent;","    }","    ","    .output-tab.active {","      color: var(--text);","      border-bottom-color: var(--accent);","    }","    ","    .output-content {","      flex: 1;","      overflow: auto;","      padding: 0.75rem 1rem;","      font-family: 'Monaco', 'Menlo', monospace;","      font-size: 13px;","      line-height: 1.5;","    }","    ","    .output-content.wat {","      color: var(--cyan);","    }","    ","    .output-content.error {","      color: var(--red);","    }","    ","    .output-content.console {","      color: var(--green);","    }","    ","    /* Empty state */","    .empty-state {","      flex: 1;","      display: flex;","      flex-direction: column;","      align-items: center;","      justify-content: center;","      color: var(--text-dim);","    }","    ","    .empty-state-icon {","      font-size: 4rem;","      margin-bottom: 1rem;","      opacity: 0.5;","    }","    ","    /* Modal */","    .modal-overlay {","      position: fixed;","      top: 0;","      left: 0;","      right: 0;","      bottom: 0;","      background: rgba(0,0,0,0.5);","      display: flex;","      align-items: center;","      justify-content: center;","      z-index: 1000;","    }","    ","    .modal {","      background: var(--bg-darker);","      border: 1px solid var(--border);","      border-radius: 8px;","      padding: 1.5rem;","      min-width: 300px;","    }","    ","    .modal h3 {","      margin-bottom: 1rem;","      color: var(--accent);","    }","    ","    .modal input {","      width: 100%;","      padding: 0.5rem;","      background: var(--bg-dark);","      border: 1px solid var(--border);","      border-radius: 4px;","      color: var(--text);","      margin-bottom: 1rem;","    }","    ","    .modal input:focus {","      outline: none;","      border-color: var(--accent);","    }","    ","    .modal-buttons {","      display: flex;","      justify-content: flex-end;","      gap: 0.5rem;","    }","    ","    .hidden { display: none !important; }","  </style>","</head>","<body>","  <header>","    <div class=\"logo\">","      <span class=\"logo-icon\">‚ú®</span>","      <span>Encantis IDE</span>","    </div>","    <div class=\"toolbar\">","      <button class=\"toolbar-btn\" onclick=\"newFile()\">+ New File</button>","      <button class=\"toolbar-btn primary\" onclick=\"compile()\">‚ñ∂ Compile</button>","      <button class=\"toolbar-btn primary\" onclick=\"run()\">‚ö° Run</button>","    </div>","  </header>","  ","  <div class=\"main-container\">","    <div class=\"sidebar\">","      <div class=\"sidebar-header\">","        <span>Explorer</span>","        <button onclick=\"newFile()\" title=\"New File\">+</button>","      </div>","      <div class=\"file-tree\" id=\"file-tree\"></div>","    </div>","    ","    <div class=\"editor-area\">","      <div class=\"tabs\" id=\"tabs\"></div>","      <div class=\"editor-container\" id=\"editor-container\">","        <div class=\"empty-state\" id=\"empty-state\">","          <div class=\"empty-state-icon\">üìù</div>","          <p>Create or select a file to start editing</p>","        </div>","        <div class=\"line-numbers hidden\" id=\"line-numbers\"></div>","        <div class=\"editor-wrapper hidden\" id=\"editor-wrapper\">","          <div class=\"syntax-highlight\" id=\"syntax-highlight\"></div>","          <textarea class=\"editor\" id=\"editor\" spellcheck=\"false\"></textarea>","        </div>","      </div>","      ","      <div class=\"output-panel\">","        <div class=\"output-tabs\">","          <button class=\"output-tab active\" onclick=\"showOutput('wat')\">WAT Output</button>","          <button class=\"output-tab\" onclick=\"showOutput('console')\">Console</button>","          <button class=\"output-tab\" onclick=\"showOutput('errors')\">Errors</button>","        </div>","        <div class=\"output-content wat\" id=\"output-content\">","          <span style=\"color: var(--text-dim)\">-- Compile to see WAT output --</span>","        </div>","      </div>","    </div>","  </div>","  ","  <div class=\"modal-overlay hidden\" id=\"new-file-modal\">","    <div class=\"modal\">","      <h3>New File</h3>","      <input type=\"text\" id=\"new-file-name\" placeholder=\"filename.ents\" autofocus>","      <div class=\"modal-buttons\">","        <button class=\"toolbar-btn\" onclick=\"closeModal()\">Cancel</button>","        <button class=\"toolbar-btn primary\" onclick=\"createFile()\">Create</button>","      </div>","    </div>","  </div>","","  <script>","    // State","    const files = new Map();","    let activeFile = null;","    let openTabs = [];","    let currentOutput = 'wat';","    let outputs = { wat: '', console: '', errors: '' };","    ","    // Sample files","    const sampleFiles = {","      'main.ents': `-- Main program","-- Encantis: A language that compiles to WebAssembly","","func add(a:i32, b:i32) -> i32 {","  a + b","}","","func factorial(n:i32) -> i32 {","  if n <= 1 {","    1","  } else {","    n * factorial(n - 1)","  }","}","","export func main() -> i32 {","  local x:i32 = add(10, 20)","  local y:i32 = factorial(5)","  x + y","}`,","      'math.ents': `-- Math utilities","","func abs(n:i32) -> i32 {","  if n < 0 { -n } else { n }","}","","func max(a:i32, b:i32) -> i32 {","  if a > b { a } else { b }","}","","func min(a:i32, b:i32) -> i32 {","  if a < b { a } else { b }","}","","func clamp(val:i32, lo:i32, hi:i32) -> i32 {","  max(lo, min(hi, val))","}`,","      'strings.ents': `-- String handling (using slices)","","-- String length from null-terminated slice","func strlen(s:[u8/0]) -> i32 {","  local len:i32 = 0","  while s[len] != 0 {","    len = len + 1","  }","  len","}","","-- Compare two strings","func strcmp(a:[u8], b:[u8]) -> i32 {","  local i:i32 = 0","  while i < a.len && i < b.len {","    if a[i] != b[i] {","      a[i] - b[i]","    }","    i = i + 1","  }","  a.len - b.len","}`","    };","    ","    // Initialize with sample files","    function init() {","      for (const [name, content] of Object.entries(sampleFiles)) {","        files.set(name, { content, modified: false });","      }","      renderFileTree();","      openFile('main.ents');","    }","    ","    // File operations","    function newFile() {","      document.getElementById('new-file-modal').classList.remove('hidden');","      const input = document.getElementById('new-file-name');","      input.value = '';","      input.focus();","    }","    ","    function closeModal() {","      document.getElementById('new-file-modal').classList.add('hidden');","    }","    ","    function createFile() {","      const name = document.getElementById('new-file-name').value.trim();","      if (!name) return;","      ","      const fileName = name.endsWith('.ents') ? name : name + '.ents';","      if (files.has(fileName)) {","        alert('File already exists');","        return;","      }","      ","      files.set(fileName, { content: `-- ${fileName}\\n\\n`, modified: false });","      renderFileTree();","      openFile(fileName);","      closeModal();","    }","    ","    function deleteFile(name, e) {","      e.stopPropagation();","      if (!confirm(`Delete ${name}?`)) return;","      ","      files.delete(name);","      openTabs = openTabs.filter(t => t !== name);","      if (activeFile === name) {","        activeFile = openTabs[0] || null;","      }","      renderFileTree();","      renderTabs();","      renderEditor();","    }","    ","    function openFile(name) {","      if (!files.has(name)) return;","      ","      // Save current file first","      if (activeFile) {","        saveCurrentFile();","      }","      ","      activeFile = name;","      if (!openTabs.includes(name)) {","        openTabs.push(name);","      }","      ","      renderFileTree();","      renderTabs();","      renderEditor();","    }","    ","    function closeTab(name, e) {","      e.stopPropagation();","      openTabs = openTabs.filter(t => t !== name);","      if (activeFile === name) {","        activeFile = openTabs[openTabs.length - 1] || null;","      }","      renderTabs();","      renderEditor();","    }","    ","    function saveCurrentFile() {","      if (!activeFile) return;","      const editor = document.getElementById('editor');","      const file = files.get(activeFile);","      if (file) {","        file.content = editor.value;","      }","    }","    ","    // Rendering","    function renderFileTree() {","      const tree = document.getElementById('file-tree');","      tree.innerHTML = Array.from(files.entries())","        .sort((a, b) => a[0].localeCompare(b[0]))","        .map(([name, file]) => `","          <div class=\"file-item file ${name === activeFile ? 'active' : ''}\" onclick=\"openFile('${name}')\">","            <span class=\"file-icon\">üìÑ</span>","            <span class=\"file-name\">${name}</span>","            ${file.modified ? '<span class=\"tab-modified\"></span>' : ''}","            <div class=\"file-actions\">","              <button class=\"file-action\" onclick=\"deleteFile('${name}', event)\" title=\"Delete\">√ó</button>","            </div>","          </div>","        `).join('');","    }","    ","    function renderTabs() {","      const tabs = document.getElementById('tabs');","      tabs.innerHTML = openTabs.map(name => {","        const file = files.get(name);","        return `","          <button class=\"tab ${name === activeFile ? 'active' : ''}\" onclick=\"openFile('${name}')\">","            ${file?.modified ? '<span class=\"tab-modified\"></span>' : ''}","            ${name}","            <span class=\"tab-close\" onclick=\"closeTab('${name}', event)\">√ó</span>","          </button>","        `;","      }).join('');","    }","    ","    function renderEditor() {","      const emptyState = document.getElementById('empty-state');","      const lineNumbers = document.getElementById('line-numbers');","      const editorWrapper = document.getElementById('editor-wrapper');","      const editor = document.getElementById('editor');","      ","      if (!activeFile) {","        emptyState.classList.remove('hidden');","        lineNumbers.classList.add('hidden');","        editorWrapper.classList.add('hidden');","        return;","      }","      ","      emptyState.classList.add('hidden');","      lineNumbers.classList.remove('hidden');","      editorWrapper.classList.remove('hidden');","      ","      const file = files.get(activeFile);","      editor.value = file?.content || '';","      updateLineNumbers();","      updateSyntaxHighlight();","    }","    ","    function updateLineNumbers() {","      const editor = document.getElementById('editor');","      const lineNumbers = document.getElementById('line-numbers');","      const lines = editor.value.split('\\n').length;","      lineNumbers.innerHTML = Array.from({ length: lines }, (_, i) => i + 1).join('<br>');","    }","    ","    // Syntax highlighting - Encantis tokenizer","    function updateSyntaxHighlight() {","      const editor = document.getElementById('editor');","      const highlightEl = document.getElementById('syntax-highlight');","      ","      const code = editor.value;","      highlightEl.innerHTML = highlightCode(code);","    }","    ","    function highlightCode(code) {","      // Token patterns for Encantis","      const patterns = [","        // Comments (highest priority)","        { regex: /--[^\\n]*/g, class: 'comment' },","        // Strings","        { regex: /\"(?:[^\"\\\\]|\\\\.)*\"/g, class: 'string' },","        // Keywords","        { regex: /\\b(func|local|if|else|elif|while|do|block|loop|end|break|continue|export|import|memory|return)\\b/g, class: 'keyword' },","        // Types","        { regex: /\\b(i32|u32|i64|u64|f32|f64|i8|i16|u8|u16|bool|void)\\b/g, class: 'type' },","        // Built-in constants","        { regex: /\\b(true|false|nil)\\b/g, class: 'constant' },","        // Numbers (hex, binary, decimal, float)","        { regex: /\\b0x[0-9a-fA-F_]+\\b/g, class: 'number' },","        { regex: /\\b0b[01_]+\\b/g, class: 'number' },","        { regex: /\\b0o[0-7_]+\\b/g, class: 'number' },","        { regex: /\\b\\d+(\\.\\d+)?([eE][+-]?\\d+)?\\b/g, class: 'number' },","        // Operators","        { regex: /->|=>|<=|>=|==|!=|&&|\\|\\||<<|>>|<<<|>>>|\\+\\+|--/g, class: 'operator' },","        // Punctuation","        { regex: /[{}()\\[\\]:;,\\.]/g, class: 'punctuation' },","        // Function names (word followed by open paren)","        { regex: /\\b([a-zA-Z_][a-zA-Z0-9_]*)\\s*(?=\\()/g, class: 'function' },","      ];","      ","      // Create spans for each token","      let result = escapeHtml(code);","      ","      // Apply patterns in order of priority","      const tokens = [];","      ","      for (const { regex, class: className } of patterns) {","        let match;","        regex.lastIndex = 0;","        while ((match = regex.exec(code)) !== null) {","          tokens.push({","            start: match.index,","            end: match.index + match[0].length,","            text: match[0],","            class: className","          });","        }","      }","      ","      // Sort by position, then by length (longer matches win)","      tokens.sort((a, b) => a.start - b.start || b.end - a.end);","      ","      // Remove overlapping tokens (keep first/longest)","      const filtered = [];","      let lastEnd = -1;","      for (const token of tokens) {","        if (token.start >= lastEnd) {","          filtered.push(token);","          lastEnd = token.end;","        }","      }","      ","      // Build highlighted output","      let output = '';","      let pos = 0;","      ","      for (const token of filtered) {","        // Add unhighlighted text before token","        if (token.start > pos) {","          output += escapeHtml(code.slice(pos, token.start));","        }","        // Add highlighted token","        output += `<span class=\"hl-${token.class}\">${escapeHtml(token.text)}</span>`;","        pos = token.end;","      }","      ","      // Add remaining text","      if (pos < code.length) {","        output += escapeHtml(code.slice(pos));","      }","      ","      return output;","    }","    ","    function escapeHtml(text) {","      return text","        .replace(/&/g, '&amp;')","        .replace(/</g, '&lt;')","        .replace(/>/g, '&gt;');","    }","    ","    ","    // Output panel","    function showOutput(type) {","      currentOutput = type;","      document.querySelectorAll('.output-tab').forEach(t => t.classList.remove('active'));","      event.target.classList.add('active');","      ","      const content = document.getElementById('output-content');","      content.className = 'output-content ' + type;","      content.innerHTML = outputs[type] || `<span style=\"color: var(--text-dim)\">-- No ${type} output --</span>`;","    }","    ","    // ============================================","    // ENCANTIS COMPILER (Subset ‚Üí WAT)","    // ============================================","    ","    class EncantisCompiler {","      constructor(source, filename) {","        this.source = source;","        this.filename = filename;","        this.pos = 0;","        this.line = 1;","        this.col = 1;","        this.tokens = [];","        this.current = 0;","        this.errors = [];","        this.functions = new Map();","      }","      ","      // ============ TOKENIZER ============","      ","      tokenize() {","        while (this.pos < this.source.length) {","          this.skipWhitespaceAndComments();","          if (this.pos >= this.source.length) break;","          ","          const start = { line: this.line, col: this.col };","          const ch = this.source[this.pos];","          ","          // Numbers","          if (/[0-9]/.test(ch)) {","            this.tokens.push(this.readNumber(start));","            continue;","          }","          ","          // Identifiers and keywords","          if (/[a-zA-Z_]/.test(ch)) {","            this.tokens.push(this.readIdentifier(start));","            continue;","          }","          ","          // Strings","          if (ch === '\"') {","            this.tokens.push(this.readString(start));","            continue;","          }","          ","          // Multi-char operators","          const twoChar = this.source.slice(this.pos, this.pos + 2);","          if (['->','<=','>=','==','!=','&&','||'].includes(twoChar)) {","            this.advance(); this.advance();","            this.tokens.push({ type: 'operator', value: twoChar, ...start });","            continue;","          }","          ","          // Single-char tokens","          if ('+-*/%<>=!&|^~(){}[]:;,.'.includes(ch)) {","            this.advance();","            this.tokens.push({ type: 'operator', value: ch, ...start });","            continue;","          }","          ","          this.error(`Unexpected character: ${ch}`, start);","          this.advance();","        }","        ","        this.tokens.push({ type: 'EOF', value: '', line: this.line, col: this.col });","        return this.tokens;","      }","      ","      skipWhitespaceAndComments() {","        while (this.pos < this.source.length) {","          const ch = this.source[this.pos];","          if (ch === ' ' || ch === '\\t' || ch === '\\r') {","            this.advance();","          } else if (ch === '\\n') {","            this.advance();","            this.line++;","            this.col = 1;","          } else if (this.source.slice(this.pos, this.pos + 2) === '--') {","            while (this.pos < this.source.length && this.source[this.pos] !== '\\n') {","              this.advance();","            }","          } else {","            break;","          }","        }","      }","      nextChar() {","        this.pos++;","        this.col++;","      }","      ","      readNumber(start) {","        let value = '';","        // Handle hex/binary","        if (this.source[this.pos] === '0' && this.pos + 1 < this.source.length) {","          const next = this.source[this.pos + 1];","          if (next === 'x' || next === 'X') {","            value = '0x';","            this.advance(); this.advance();","            while (/[0-9a-fA-F_]/.test(this.source[this.pos] || '')) {","              if (this.source[this.pos] !== '_') value += this.source[this.pos];","              this.advance();","            }","            return { type: 'number', value: parseInt(value, 16), ...start };","          }","          if (next === 'b' || next === 'B') {","            this.advance(); this.advance();","            while (/[01_]/.test(this.source[this.pos] || '')) {","              if (this.source[this.pos] !== '_') value += this.source[this.pos];","              this.advance();","            }","            return { type: 'number', value: parseInt(value, 2), ...start };","          }","        }","        ","        while (/[0-9_]/.test(this.source[this.pos] || '')) {","          if (this.source[this.pos] !== '_') value += this.source[this.pos];","          this.advance();","        }","        ","        // Float?","        if (this.source[this.pos] === '.' && /[0-9]/.test(this.source[this.pos + 1] || '')) {","          value += '.';","          this.advance();","          while (/[0-9_]/.test(this.source[this.pos] || '')) {","            if (this.source[this.pos] !== '_') value += this.source[this.pos];","            this.advance();","          }","          return { type: 'number', value: parseFloat(value), ...start, float: true };","        }","        ","        return { type: 'number', value: parseInt(value, 10), ...start };","      }","      ","      readIdentifier(start) {","        let value = '';","        while (/[a-zA-Z0-9_]/.test(this.source[this.pos] || '')) {","          value += this.source[this.pos];","          this.advance();","        }","        const keywords = ['func','local','var','if','else','elif','while','do','block','loop','end','break','continue','export','import','memory','return','true','false','nil'];","        const types = ['i32','u32','i64','u64','f32','f64','i8','i16','u8','u16','bool','void'];","        ","        if (keywords.includes(value)) {","          return { type: 'keyword', value, ...start };","        }","        if (types.includes(value)) {","          return { type: 'type', value, ...start };","        }","        return { type: 'identifier', value, ...start };","      }","      ","      readString(start) {","        let value = '';","        this.advance(); // skip opening quote","        while (this.pos < this.source.length && this.source[this.pos] !== '\"') {","          if (this.source[this.pos] === '\\\\' && this.pos + 1 < this.source.length) {","            this.advance();","            const esc = this.source[this.pos];","            if (esc === 'n') value += '\\n';","            else if (esc === 't') value += '\\t';","            else if (esc === 'r') value += '\\r';","            else if (esc === '\\\\') value += '\\\\';","            else if (esc === '\"') value += '\"';","            else value += esc;","          } else {","            value += this.source[this.pos];","          }","          this.advance();","        }","        this.advance(); // skip closing quote","        return { type: 'string', value, ...start };","      }","      ","      // ============ PARSER ============","      ","      parse() {","        const ast = { type: 'module', functions: [], exports: [] };","        ","        while (!this.isAtEnd()) {","          if (this.check('keyword', 'export')) {","            this.advance();","            if (this.check('keyword', 'func')) {","              const fn = this.parseFunction();","              fn.exported = true;","              ast.functions.push(fn);","              ast.exports.push(fn.name);","            }","          } else if (this.check('keyword', 'func')) {","            ast.functions.push(this.parseFunction());","          } else {","            this.error(`Unexpected token: ${this.peek().value}`);","            this.advance();","          }","        }","        ","        return ast;","      }","      ","      parseFunction() {","        this.expect('keyword', 'func');","        const name = this.expect('identifier').value;","        this.expect('operator', '(');","        ","        const params = [];","        while (!this.check('operator', ')')) {","          const paramName = this.expect('identifier').value;","          this.expect('operator', ':');","          const paramType = this.parseType();","          params.push({ name: paramName, type: paramType });","          if (this.check('operator', ',')) this.advance();","        }","        this.expect('operator', ')');","        ","        let returnType = null;","        if (this.check('operator', '->')) {","          this.advance();","          returnType = this.parseType();","        }","        ","        this.expect('operator', '{');","        const body = this.parseBlock();","        this.expect('operator', '}');","        ","        this.functions.set(name, { params, returnType });","        ","        return { type: 'function', name, params, returnType, body };","      }","      ","      parseType() {","        if (this.check('type')) {","          return this.advance().value;","        }","        if (this.check('identifier')) {","          return this.advance().value;","        }","        this.error('Expected type');","        return 'i32';","      }","      ","      parseBlock() {","        const statements = [];","        while (!this.check('operator', '}') && !this.isAtEnd()) {","          statements.push(this.parseStatement());","        }","        return { type: 'block', statements };","      }","      ","      parseStatement() {","        if (this.check('keyword', 'local') || this.check('keyword', 'var')) {","          return this.parseLocalDecl();","        }","        if (this.check('keyword', 'if')) {","          return this.parseIf();","        }","        if (this.check('keyword', 'while')) {","          return this.parseWhile();","        }","        if (this.check('keyword', 'return')) {","          this.advance();","          const value = this.parseExpression();","          return { type: 'return', value };","        }","        ","        // Expression statement (could be assignment or just expression)","        const expr = this.parseExpression();","        ","        // Check for assignment","        if (this.check('operator', '=') && expr.type === 'identifier') {","          this.advance();","          const value = this.parseExpression();","          return { type: 'assign', name: expr.name, value };","        }","        ","        return { type: 'expr', value: expr };","      }","      ","      parseLocalDecl() {","        this.advance(); // skip 'local' or 'var'","        const name = this.expect('identifier').value;","        ","        let varType = 'i32';","        if (this.check('operator', ':')) {","          this.advance();","          varType = this.parseType();","        }","        ","        let init = null;","        if (this.check('operator', '=')) {","          this.advance();","          init = this.parseExpression();","        }","        ","        return { type: 'local', name, varType, init };","      }","      ","      parseIf() {","        this.expect('keyword', 'if');","        const condition = this.parseExpression();","        this.expect('operator', '{');","        const thenBlock = this.parseBlock();","        this.expect('operator', '}');","        ","        let elseBlock = null;","        if (this.check('keyword', 'else')) {","          this.advance();","          if (this.check('keyword', 'if')) {","            elseBlock = { type: 'block', statements: [this.parseIf()] };","          } else {","            this.expect('operator', '{');","            elseBlock = this.parseBlock();","            this.expect('operator', '}');","          }","        }","        ","        return { type: 'if', condition, thenBlock, elseBlock };","      }","      ","      parseWhile() {","        this.expect('keyword', 'while');","        const condition = this.parseExpression();","        this.expect('operator', '{');","        const body = this.parseBlock();","        this.expect('operator', '}');","        ","        return { type: 'while', condition, body };","      }","      ","      parseExpression() {","        return this.parseOr();","      }","      ","      parseOr() {","        let left = this.parseAnd();","        while (this.check('operator', '||')) {","          this.advance();","          const right = this.parseAnd();","          left = { type: 'binary', op: '||', left, right };","        }","        return left;","      }","      ","      parseAnd() {","        let left = this.parseEquality();","        while (this.check('operator', '&&')) {","          this.advance();","          const right = this.parseEquality();","          left = { type: 'binary', op: '&&', left, right };","        }","        return left;","      }","      ","      parseEquality() {","        let left = this.parseComparison();","        while (this.check('operator', '==') || this.check('operator', '!=')) {","          const op = this.advance().value;","          const right = this.parseComparison();","          left = { type: 'binary', op, left, right };","        }","        return left;","      }","      ","      parseComparison() {","        let left = this.parseAdditive();","        while (this.check('operator', '<') || this.check('operator', '>') ||","               this.check('operator', '<=') || this.check('operator', '>=')) {","          const op = this.advance().value;","          const right = this.parseAdditive();","          left = { type: 'binary', op, left, right };","        }","        return left;","      }","      ","      parseAdditive() {","        let left = this.parseMultiplicative();","        while (this.check('operator', '+') || this.check('operator', '-')) {","          const op = this.advance().value;","          const right = this.parseMultiplicative();","          left = { type: 'binary', op, left, right };","        }","        return left;","      }","      ","      parseMultiplicative() {","        let left = this.parseUnary();","        while (this.check('operator', '*') || this.check('operator', '/') || this.check('operator', '%')) {","          const op = this.advance().value;","          const right = this.parseUnary();","          left = { type: 'binary', op, left, right };","        }","        return left;","      }","      ","      parseUnary() {","        if (this.check('operator', '-') || this.check('operator', '!')) {","          const op = this.advance().value;","          const operand = this.parseUnary();","          return { type: 'unary', op, operand };","        }","        return this.parseCall();","      }","      ","      parseCall() {","        let expr = this.parsePrimary();","        ","        while (this.check('operator', '(')) {","          this.advance();","          const args = [];","          while (!this.check('operator', ')')) {","            args.push(this.parseExpression());","            if (this.check('operator', ',')) this.advance();","          }","          this.expect('operator', ')');","          expr = { type: 'call', callee: expr.name, args };","        }","        ","        return expr;","      }","      ","      parsePrimary() {","        if (this.check('number')) {","          const tok = this.advance();","          return { type: 'number', value: tok.value, float: tok.float };","        }","        if (this.check('identifier')) {","          return { type: 'identifier', name: this.advance().value };","        }","        if (this.check('keyword', 'true')) {","          this.advance();","          return { type: 'number', value: 1 };","        }","        if (this.check('keyword', 'false')) {","          this.advance();","          return { type: 'number', value: 0 };","        }","        if (this.check('operator', '(')) {","          this.advance();","          const expr = this.parseExpression();","          this.expect('operator', ')');","          return expr;","        }","        ","        this.error(`Unexpected token in expression: ${this.peek().value}`);","        this.advance();","        return { type: 'number', value: 0 };","      }","      ","      // Parser helpers","      peek() { return this.tokens[this.current]; }","      isAtEnd() { return this.peek().type === 'EOF'; }","      check(type, value) {","        const tok = this.peek();","        if (value !== undefined) return tok.type === type && tok.value === value;","        return tok.type === type;","      }","      advance() {","        if (!this.isAtEnd()) this.current++;","        return this.tokens[this.current - 1];","      }","      expect(type, value) {","        if (this.check(type, value)) return this.advance();","        const tok = this.peek();","        this.error(`Expected ${value || type}, got ${tok.value}`);","        return tok;","      }","      ","      error(msg, loc) {","        const location = loc || this.peek();","        this.errors.push(`${this.filename}:${location.line}:${location.col}: ${msg}`);","      }","      ","      // ============ CODE GENERATOR ============","      ","      generate(ast) {","        let wat = '(module\\n';","        ","        // Generate functions","        for (const fn of ast.functions) {","          wat += this.genFunction(fn);","        }","        ","        // Generate exports","        for (const name of ast.exports) {","          wat += `  (export \"${name}\" (func $${name}))\\n`;","        }","        ","        wat += ')\\n';","        return wat;","      }","      ","      genFunction(fn) {","        let code = `  (func $${fn.name}`;","        ","        // Parameters","        for (const param of fn.params) {","          code += ` (param $${param.name} ${this.watType(param.type)})`;","        }","        ","        // Return type","        if (fn.returnType) {","          code += ` (result ${this.watType(fn.returnType)})`;","        }","        ","        code += '\\n';","        ","        // Collect locals","        const locals = this.collectLocals(fn.body);","        for (const [name, type] of locals) {","          code += `    (local $${name} ${this.watType(type)})\\n`;","        }","        ","        // Generate body","        code += this.genBlock(fn.body, fn.returnType, 2);","        ","        code += '  )\\n';","        return code;","      }","      ","      collectLocals(block, locals = new Map()) {","        for (const stmt of block.statements) {","          if (stmt.type === 'local') {","            locals.set(stmt.name, stmt.varType);","          }","          if (stmt.type === 'if') {","            this.collectLocals(stmt.thenBlock, locals);","            if (stmt.elseBlock) this.collectLocals(stmt.elseBlock, locals);","          }","          if (stmt.type === 'while') {","            this.collectLocals(stmt.body, locals);","          }","        }","        return locals;","      }","      ","      genBlock(block, returnType, indent) {","        const pad = '    '.repeat(indent);","        let code = '';","        ","        const stmts = block.statements;","        for (let i = 0; i < stmts.length; i++) {","          const stmt = stmts[i];","          const isLast = i === stmts.length - 1;","          code += this.genStatement(stmt, returnType, indent, isLast);","        }","        ","        return code;","      }","      ","      genStatement(stmt, returnType, indent, isLast) {","        const pad = '    '.repeat(indent);","        ","        switch (stmt.type) {","          case 'local': {","            let code = '';","            if (stmt.init) {","              code += this.genExpr(stmt.init, indent);","              code += `${pad}local.set $${stmt.name}\\n`;","            }","            return code;","          }","          ","          case 'assign': {","            let code = this.genExpr(stmt.value, indent);","            code += `${pad}local.set $${stmt.name}\\n`;","            return code;","          }","          ","          case 'return': {","            return this.genExpr(stmt.value, indent);","          }","          ","          case 'expr': {","            let code = this.genExpr(stmt.value, indent);","            // Drop result if not last statement with return type","            if (!isLast || !returnType) {","              code += `${pad}drop\\n`;","            }","            return code;","          }","          ","          case 'if': {","            let code = this.genExpr(stmt.condition, indent);","            ","            if (returnType && isLast) {","              // If expression (returns value)","              code += `${pad}(if (result ${this.watType(returnType)})\\n`;","              code += `${pad}  (then\\n`;","              code += this.genBlock(stmt.thenBlock, returnType, indent + 2);","              code += `${pad}  )\\n`;","              if (stmt.elseBlock) {","                code += `${pad}  (else\\n`;","                code += this.genBlock(stmt.elseBlock, returnType, indent + 2);","                code += `${pad}  )\\n`;","              } else {","                code += `${pad}  (else\\n`;","                code += `${pad}    ${this.watType(returnType)}.const 0\\n`;","                code += `${pad}  )\\n`;","              }","              code += `${pad})\\n`;","            } else {","              // If statement (no value)","              code += `${pad}(if\\n`;","              code += `${pad}  (then\\n`;","              code += this.genBlock(stmt.thenBlock, null, indent + 2);","              code += `${pad}  )\\n`;","              if (stmt.elseBlock) {","                code += `${pad}  (else\\n`;","                code += this.genBlock(stmt.elseBlock, null, indent + 2);","                code += `${pad}  )\\n`;","              }","              code += `${pad})\\n`;","            }","            return code;","          }","          ","          case 'while': {","            let code = `${pad}(block $break\\n`;","            code += `${pad}  (loop $continue\\n`;","            code += this.genExpr(stmt.condition, indent + 2);","            code += `${pad}    i32.eqz\\n`;","            code += `${pad}    br_if $break\\n`;","            code += this.genBlock(stmt.body, null, indent + 2);","            code += `${pad}    br $continue\\n`;","            code += `${pad}  )\\n`;","            code += `${pad})\\n`;","            return code;","          }","        }","        ","        return '';","      }","      ","      genExpr(expr, indent) {","        const pad = '    '.repeat(indent);","        ","        switch (expr.type) {","          case 'number':","            if (expr.float) {","              return `${pad}f64.const ${expr.value}\\n`;","            }","            return `${pad}i32.const ${expr.value}\\n`;","          ","          case 'identifier':","            return `${pad}local.get $${expr.name}\\n`;","          ","          case 'binary': {","            let code = this.genExpr(expr.left, indent);","            code += this.genExpr(expr.right, indent);","            ","            const ops = {","              '+': 'i32.add', '-': 'i32.sub', '*': 'i32.mul',","              '/': 'i32.div_s', '%': 'i32.rem_s',","              '<': 'i32.lt_s', '>': 'i32.gt_s',","              '<=': 'i32.le_s', '>=': 'i32.ge_s',","              '==': 'i32.eq', '!=': 'i32.ne',","              '&&': 'i32.and', '||': 'i32.or'","            };","            ","            code += `${pad}${ops[expr.op] || 'i32.add'}\\n`;","            return code;","          }","          ","          case 'unary': {","            if (expr.op === '-') {","              let code = `${pad}i32.const 0\\n`;","              code += this.genExpr(expr.operand, indent);","              code += `${pad}i32.sub\\n`;","              return code;","            }","            if (expr.op === '!') {","              let code = this.genExpr(expr.operand, indent);","              code += `${pad}i32.eqz\\n`;","              return code;","            }","            return this.genExpr(expr.operand, indent);","          }","          ","          case 'call': {","            let code = '';","            for (const arg of expr.args) {","              code += this.genExpr(arg, indent);","            }","            code += `${pad}call $${expr.callee}\\n`;","            return code;","          }","        }","        ","        return `${pad}i32.const 0\\n`;","      }","      ","      watType(type) {","        const map = {","          'i32': 'i32', 'u32': 'i32',","          'i64': 'i64', 'u64': 'i64',","          'f32': 'f32', 'f64': 'f64',","          'bool': 'i32', 'void': ''","        };","        return map[type] || 'i32';","      }","      ","      // ============ COMPILE ============","      ","      compile() {","        this.tokenize();","        if (this.errors.length > 0) return { wat: null, errors: this.errors };","        ","        const ast = this.parse();","        if (this.errors.length > 0) return { wat: null, errors: this.errors };","        ","        const wat = this.generate(ast);","        return { wat, errors: this.errors };","      }","    }","    ","    // Compilation - uses EncantisCompiler","    function compile() {","      saveCurrentFile();","      if (!activeFile) {","        outputs.errors = 'No file selected';","        showOutput('errors');","        return;","      }","      ","      const file = files.get(activeFile);","      const compiler = new EncantisCompiler(file.content, activeFile);","      const result = compiler.compile();","      ","      if (result.errors.length > 0) {","        outputs.errors = result.errors.join('\\n');","        outputs.wat = '';","        showOutput('errors');","        document.querySelectorAll('.output-tab').forEach(t => t.classList.remove('active'));","        document.querySelectorAll('.output-tab')[2].classList.add('active');","      } else {","        outputs.wat = result.wat;","        outputs.errors = '';","        outputs.console = `Compiled ${activeFile} successfully!`;","        ","        document.querySelectorAll('.output-tab').forEach(t => t.classList.remove('active'));","        document.querySelector('.output-tab').classList.add('active');","        const content = document.getElementById('output-content');","        content.className = 'output-content wat';","        content.textContent = outputs.wat;","      }","    }","    // Run (placeholder - will implement in v4)","    function run() {","      compile();","      outputs.console = '> Running main()...\\n> Result: 42\\n\\n(WASM execution coming in v4)';","      showOutput('console');","      document.querySelectorAll('.output-tab').forEach(t => t.classList.remove('active'));","      document.querySelectorAll('.output-tab')[1].classList.add('active');","    }","    ","    // Editor events","    document.getElementById('editor').addEventListener('input', () => {","      const file = files.get(activeFile);","      if (file) {","        file.modified = true;","        renderFileTree();","        renderTabs();","      }","      updateLineNumbers();","      updateSyntaxHighlight();","    });","    ","    document.getElementById('editor').addEventListener('scroll', () => {","      const editor = document.getElementById('editor');","      const lineNumbers = document.getElementById('line-numbers');","      const syntaxHighlight = document.getElementById('syntax-highlight');","      lineNumbers.scrollTop = editor.scrollTop;","      syntaxHighlight.scrollTop = editor.scrollTop;","      syntaxHighlight.scrollLeft = editor.scrollLeft;","    });","    ","    document.getElementById('editor').addEventListener('keydown', (e) => {","      // Tab key inserts spaces","      if (e.key === 'Tab') {","        e.preventDefault();","        const editor = e.target;","        const start = editor.selectionStart;","        const end = editor.selectionEnd;","        editor.value = editor.value.substring(0, start) + '  ' + editor.value.substring(end);","        editor.selectionStart = editor.selectionEnd = start + 2;","        editor.dispatchEvent(new Event('input'));","      }","      ","      // Ctrl+S to save","      if (e.ctrlKey && e.key === 's') {","        e.preventDefault();","        saveCurrentFile();","        const file = files.get(activeFile);","        if (file) file.modified = false;","        renderFileTree();","        renderTabs();","      }","    });","    ","    // Modal events","    document.getElementById('new-file-name').addEventListener('keydown', (e) => {","      if (e.key === 'Enter') createFile();","      if (e.key === 'Escape') closeModal();","    });","    ","    // Initialize","    init();","  </script>","</body>","</html>",""]}