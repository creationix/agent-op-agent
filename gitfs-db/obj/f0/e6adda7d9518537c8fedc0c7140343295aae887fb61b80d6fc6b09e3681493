{"type":"text","lines":["<!DOCTYPE html>","<html lang=\"en\">","<head>","  <meta charset=\"UTF-8\">","  <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">","  <title>D2 Playground - JSONL Format Explorer</title>","  <style>","    * { margin: 0; padding: 0; box-sizing: border-box; }","    ","    body {","      font-family: system-ui, -apple-system, sans-serif;","      background: #1a1a2e;","      color: #eee;","      height: 100vh;","      display: flex;","      flex-direction: column;","    }","    ","    header {","      background: #16213e;","      padding: 1rem 2rem;","      border-bottom: 1px solid #0f3460;","      display: flex;","      align-items: center;","      gap: 2rem;","    }","    ","    header h1 {","      font-size: 1.5rem;","      color: #e94560;","    }","    ","    header p {","      color: #888;","      font-size: 0.9rem;","    }","    ","    .stats {","      margin-left: auto;","      display: flex;","      gap: 1.5rem;","      font-size: 0.85rem;","    }","    ","    .stat {","      display: flex;","      flex-direction: column;","      align-items: center;","    }","    ","    .stat-value {","      font-size: 1.2rem;","      font-weight: bold;","      color: #e94560;","    }","    ","    .stat-label {","      color: #888;","      font-size: 0.75rem;","    }","    ","    main {","      flex: 1;","      display: flex;","      overflow: hidden;","    }","    ","    .panel {","      flex: 1;","      display: flex;","      flex-direction: column;","      border-right: 1px solid #0f3460;","    }","    ","    .panel:last-child {","      border-right: none;","    }","    ","    .panel-header {","      background: #16213e;","      padding: 0.75rem 1rem;","      font-weight: 600;","      font-size: 0.9rem;","      border-bottom: 1px solid #0f3460;","      display: flex;","      justify-content: space-between;","      align-items: center;","    }","    ","    .panel-content {","      flex: 1;","      overflow: auto;","      position: relative;","    }","    ","    textarea {","      width: 100%;","      height: 100%;","      background: #1a1a2e;","      color: #eee;","      border: none;","      padding: 1rem;","      font-family: 'Monaco', 'Menlo', monospace;","      font-size: 14px;","      resize: none;","      line-height: 1.6;","    }","    ","    textarea:focus {","      outline: none;","    }","    ","    .d2-output {","      padding: 0;","      font-family: 'Monaco', 'Menlo', monospace;","      font-size: 14px;","    }","    ","    .d2-line {","      display: flex;","      padding: 0.25rem 1rem;","      border-bottom: 1px solid #0f3460;","      cursor: pointer;","      transition: background 0.15s;","    }","    ","    .d2-line:hover {","      background: #16213e;","    }","    ","    .d2-line.highlighted {","      background: #0f3460;","    }","    ","    .d2-line.root {","      background: #1a3a1a;","    }","    ","    .line-num {","      color: #666;","      width: 3rem;","      flex-shrink: 0;","      user-select: none;","    }","    ","    .line-content {","      flex: 1;","      white-space: pre;","      overflow-x: auto;","    }","    ","    .pointer {","      color: #e94560;","      cursor: pointer;","      text-decoration: underline;","    }","    ","    .pointer:hover {","      color: #ff6b6b;","    }","    ","    .schema-ref {","      color: #4ecdc4;","    }","    ","    .string { color: #98c379; }","    .number { color: #e5c07b; }","    .boolean { color: #c678dd; }","    .null { color: #888; }","    .key { color: #61afef; }","    ","    .decoded-view {","      padding: 1rem;","      font-family: 'Monaco', 'Menlo', monospace;","      font-size: 14px;","      white-space: pre-wrap;","      line-height: 1.6;","    }","    ","    .btn {","      background: #e94560;","      color: white;","      border: none;","      padding: 0.4rem 0.8rem;","      border-radius: 4px;","      cursor: pointer;","      font-size: 0.8rem;","    }","    ","    .btn:hover {","      background: #ff6b6b;","    }","    ","    .btn-secondary {","      background: #0f3460;","    }","    ","    .btn-secondary:hover {","      background: #16213e;","    }","    ","    .error {","      color: #e94560;","      padding: 1rem;","    }","    ","    .tabs {","      display: flex;","      gap: 0.5rem;","    }","    ","    .tab {","      padding: 0.3rem 0.6rem;","      background: transparent;","      border: 1px solid #0f3460;","      color: #888;","      cursor: pointer;","      border-radius: 3px;","      font-size: 0.75rem;","    }","    ","    .tab.active {","      background: #0f3460;","      color: #eee;","    }","  </style>","</head>","<body>","  <header>","    <a href=\"../\" class=\"home-link\" title=\"Back to App Launcher\">üè†</a>","    <h1>D2 Playground</h1>","    <p>JSONL format with pointer deduplication</p>","    <div class=\"stats\">","      <div class=\"stat\">","        <span class=\"stat-value\" id=\"json-size\">0</span>","        <span class=\"stat-label\">JSON bytes</span>","      </div>","      <div class=\"stat\">","        <span class=\"stat-value\" id=\"d2-size\">0</span>","        <span class=\"stat-label\">D2 bytes</span>","      </div>","      <div class=\"stat\">","        <span class=\"stat-value\" id=\"savings\">0%</span>","        <span class=\"stat-label\">savings</span>","      </div>","      <div class=\"stat\">","        <span class=\"stat-value\" id=\"line-count\">0</span>","        <span class=\"stat-label\">lines</span>","      </div>","    </div>","  </header>","  ","  <main>","    <div class=\"panel\">","      <div class=\"panel-header\">","        <span>JSON Input</span>","        <button class=\"btn\" onclick=\"loadSample()\">Load Sample</button>","      </div>","      <div class=\"panel-content\">","        <textarea id=\"json-input\" placeholder=\"Enter JSON here...\">{","  \"name\": \"D2 Format\",","  \"version\": \"1.0\",","  \"features\": [","    {\"name\": \"Pointers\", \"type\": \"core\"},","    {\"name\": \"Schemas\", \"type\": \"core\"},","    {\"name\": \"Deduplication\", \"type\": \"optimization\"}","  ],","  \"metadata\": {","    \"author\": \"Tim Caswell\",","    \"type\": \"format\"","  }","}</textarea>","      </div>","    </div>","    ","    <div class=\"panel\">","      <div class=\"panel-header\">","        <span>D2 Output</span>","        <div class=\"tabs\">","          <button class=\"tab active\" onclick=\"setView('lines')\">Lines</button>","          <button class=\"tab\" onclick=\"setView('raw')\">Raw</button>","        </div>","      </div>","      <div class=\"panel-content\">","        <div class=\"d2-output\" id=\"d2-output\"></div>","      </div>","    </div>","    ","    <div class=\"panel\">","      <div class=\"panel-header\">","        <span>Decoded</span>","        <button class=\"btn btn-secondary\" onclick=\"copyDecoded()\">Copy</button>","      </div>","      <div class=\"panel-content\">","        <div class=\"decoded-view\" id=\"decoded-output\"></div>","      </div>","    </div>","  </main>","","  <script>","    // D2 Encoder","    class D2Encoder {","      constructor() {","        this.lines = [];","        this.valueMap = new Map(); // JSON string -> line number","        this.schemaMap = new Map(); // schema key -> line number","      }","      ","      encode(value) {","        this.lines = [];","        this.valueMap.clear();","        this.schemaMap.clear();","        ","        const rootRef = this.encodeValue(value);","        ","        // Return lines as JSONL","        return this.lines.map(l => JSON.stringify(l)).join('\\n');","      }","      ","      encodeValue(value) {","        // Check if we've seen this exact value before","        const key = JSON.stringify(value);","        if (this.valueMap.has(key)) {","          return this.valueMap.get(key);","        }","        ","        let encoded;","        ","        if (value === null || typeof value !== 'object') {","          // Primitives go directly","          encoded = value;","        } else if (Array.isArray(value)) {","          // Encode array elements recursively","          encoded = value.map(v => this.encodeValue(v));","        } else {","          // Object - check for schema optimization","          const keys = Object.keys(value);","          const schemaKey = keys.join(',');","          ","          let schemaLineNum;","          if (this.schemaMap.has(schemaKey)) {","            schemaLineNum = this.schemaMap.get(schemaKey);","          } else {","            // Create schema line","            this.lines.push(keys);","            schemaLineNum = this.lines.length;","            this.schemaMap.set(schemaKey, schemaLineNum);","          }","          ","          // Encode as [-schemaRef, ...values]","          const values = keys.map(k => this.encodeValue(value[k]));","          encoded = [-schemaLineNum, ...values];","        }","        ","        // Store and return line reference","        this.lines.push(encoded);","        const lineNum = this.lines.length;","        this.valueMap.set(key, lineNum);","        return lineNum;","      }","      ","      getLines() {","        return this.lines;","      }","    }","    ","    // D2 Decoder","    class D2Decoder {","      constructor(lines) {","        this.lines = lines;","      }","      ","      decode() {","        if (this.lines.length === 0) return null;","        // Root is the last line","        return this.resolveValue(this.lines.length);","      }","      ","      resolveValue(lineNum) {","        if (typeof lineNum !== 'number' || lineNum < 1 || lineNum > this.lines.length) {","          return lineNum; // Not a pointer, return as-is","        }","        ","        const value = this.lines[lineNum - 1]; // 1-based indexing","        ","        if (value === null || typeof value !== 'object') {","          return value;","        }","        ","        if (Array.isArray(value)) {","          // Check for schema-compressed object","          if (value.length > 0 && typeof value[0] === 'number' && value[0] < 0) {","            const schemaLineNum = -value[0];","            const schema = this.lines[schemaLineNum - 1];","            if (!Array.isArray(schema)) {","              throw new Error(`Invalid schema at line ${schemaLineNum}`);","            }","            ","            const obj = {};","            for (let i = 0; i < schema.length; i++) {","              obj[schema[i]] = this.resolveValue(value[i + 1]);","            }","            return obj;","          }","          ","          // Regular array - resolve each element","          return value.map(v => this.resolveValue(v));","        }","        ","        // Shouldn't reach here in valid D2","        return value;","      }","    }","    ","    // UI State","    let currentView = 'lines';","    let currentLines = [];","    let highlightedLine = null;","    ","    // Parse and encode","    function update() {","      const input = document.getElementById('json-input').value;","      const outputEl = document.getElementById('d2-output');","      const decodedEl = document.getElementById('decoded-output');","      ","      try {","        const json = JSON.parse(input);","        ","        // Encode","        const encoder = new D2Encoder();","        const d2Output = encoder.encode(json);","        currentLines = encoder.getLines();","        ","        // Decode back","        const decoder = new D2Decoder(currentLines);","        const decoded = decoder.decode();","        ","        // Update stats","        const jsonSize = input.length;","        const d2Size = d2Output.length;","        document.getElementById('json-size').textContent = jsonSize;","        document.getElementById('d2-size').textContent = d2Size;","        document.getElementById('line-count').textContent = currentLines.length;","        ","        const savings = ((1 - d2Size / jsonSize) * 100).toFixed(1);","        document.getElementById('savings').textContent = ","          (savings > 0 ? '+' : '') + savings + '%';","        ","        // Render output","        renderOutput(currentLines);","        decodedEl.textContent = JSON.stringify(decoded, null, 2);","        ","      } catch (e) {","        outputEl.innerHTML = `<div class=\"error\">Error: ${e.message}</div>`;","        decodedEl.textContent = '';","      }","    }","    ","    function renderOutput(lines) {","      const outputEl = document.getElementById('d2-output');","      ","      if (currentView === 'raw') {","        outputEl.innerHTML = `<textarea readonly style=\"width:100%;height:100%;background:#1a1a2e;color:#eee;border:none;padding:1rem;font-family:monospace;\">${lines.map(l => JSON.stringify(l)).join('\\n')}</textarea>`;","        return;","      }","      ","      let html = '';","      lines.forEach((line, idx) => {","        const lineNum = idx + 1;","        const isRoot = lineNum === lines.length;","        const isHighlighted = lineNum === highlightedLine;","        ","        let classes = 'd2-line';","        if (isRoot) classes += ' root';","        if (isHighlighted) classes += ' highlighted';","        ","        const content = formatLine(line, lineNum);","        ","        html += `<div class=\"${classes}\" data-line=\"${lineNum}\" onclick=\"highlightLine(${lineNum})\">","          <span class=\"line-num\">${lineNum}</span>","          <span class=\"line-content\">${content}</span>","        </div>`;","      });","      ","      outputEl.innerHTML = html;","    }","    ","    function formatLine(value, currentLine) {","      if (value === null) return '<span class=\"null\">null</span>';","      if (typeof value === 'string') return `<span class=\"string\">\"${escapeHtml(value)}\"</span>`;","      if (typeof value === 'number') return `<span class=\"number\">${value}</span>`;","      if (typeof value === 'boolean') return `<span class=\"boolean\">${value}</span>`;","      ","      if (Array.isArray(value)) {","        // Check for schema-compressed object","        if (value.length > 0 && typeof value[0] === 'number' && value[0] < 0) {","          const schemaRef = -value[0];","          const parts = [`<span class=\"schema-ref\">${value[0]}</span>`];","          for (let i = 1; i < value.length; i++) {","            parts.push(formatPointerOrValue(value[i]));","          }","          return '[' + parts.join(', ') + ']';","        }","        ","        // Check if it's a schema (array of strings)","        if (value.every(v => typeof v === 'string')) {","          return '[' + value.map(v => `<span class=\"key\">\"${escapeHtml(v)}\"</span>`).join(', ') + ']';","        }","        ","        // Regular array","        return '[' + value.map(v => formatPointerOrValue(v)).join(', ') + ']';","      }","      ","      return JSON.stringify(value);","    }","    ","    function formatPointerOrValue(value) {","      if (typeof value === 'number' && value > 0 && Number.isInteger(value) && value <= currentLines.length) {","        return `<span class=\"pointer\" onclick=\"event.stopPropagation(); highlightLine(${value})\">${value}</span>`;","      }","      if (value === null) return '<span class=\"null\">null</span>';","      if (typeof value === 'string') return `<span class=\"string\">\"${escapeHtml(value)}\"</span>`;","      if (typeof value === 'number') return `<span class=\"number\">${value}</span>`;","      if (typeof value === 'boolean') return `<span class=\"boolean\">${value}</span>`;","      return JSON.stringify(value);","    }","    ","    function escapeHtml(str) {","      return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');","    }","    ","    function highlightLine(lineNum) {","      highlightedLine = lineNum;","      renderOutput(currentLines);","      ","      // Scroll to line","      const lineEl = document.querySelector(`[data-line=\"${lineNum}\"]`);","      if (lineEl) {","        lineEl.scrollIntoView({ behavior: 'smooth', block: 'center' });","      }","    }","    ","    function setView(view) {","      currentView = view;","      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));","      event.target.classList.add('active');","      renderOutput(currentLines);","    }","    ","    function copyDecoded() {","      const text = document.getElementById('decoded-output').textContent;","      navigator.clipboard.writeText(text);","    }","    ","    function loadSample() {","      document.getElementById('json-input').value = JSON.stringify({","        \"users\": [","          {\"id\": 1, \"name\": \"Alice\", \"role\": \"admin\", \"active\": true},","          {\"id\": 2, \"name\": \"Bob\", \"role\": \"user\", \"active\": true},","          {\"id\": 3, \"name\": \"Charlie\", \"role\": \"user\", \"active\": false}","        ],","        \"config\": {","          \"version\": \"2.0\",","          \"features\": [\"auth\", \"api\", \"dashboard\"],","          \"settings\": {","            \"theme\": \"dark\",","            \"language\": \"en\"","          }","        },","        \"metadata\": {","          \"created\": \"2024-01-15\",","          \"modified\": \"2024-01-20\"","        }","      }, null, 2);","      update();","    }","    ","    // Initialize","    document.getElementById('json-input').addEventListener('input', update);","    update();","  </script>","</body>","</html>",""]}