{"type":"text","lines":["<!DOCTYPE html>","<html lang=\"en\">","<head>","  <meta charset=\"UTF-8\">","  <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">","  <title>D2 Playground - JSONL Format Explorer</title>","  <link rel=\"stylesheet\" href=\"../shared/theme.css\">","  <link rel=\"stylesheet\" href=\"../shared/widgets.css\">","  <style>","    body {","      height: 100vh;","      display: flex;","      flex-direction: column;","    }","    ","    .header-stats {","      margin-left: auto;","      display: flex;","      gap: var(--space-lg);","      font-size: 0.85rem;","    }","    ","    .header-stat {","      display: flex;","      flex-direction: column;","      align-items: center;","    }","    ","    .header-stat-value {","      font-size: 1.2rem;","      font-weight: bold;","      color: var(--accent);","    }","    ","    .header-stat-label {","      color: var(--text-dim);","      font-size: 0.7rem;","    }","    ","    main {","      flex: 1;","      display: flex;","      overflow: hidden;","    }","    ","    .panel {","      flex: 1;","      display: flex;","      flex-direction: column;","      border-right: 1px solid var(--border);","      border-radius: 0;","    }","    ","    .panel:last-child {","      border-right: none;","    }","    ","    .panel-body {","      flex: 1;","      overflow: auto;","      padding: 0;","    }","    ","    textarea {","      width: 100%;","      height: 100%;","      background: var(--bg-base);","      color: var(--text);","      border: none;","      padding: var(--space-md);","      font-family: var(--font-mono);","      font-size: 0.875rem;","      resize: none;","      line-height: 1.6;","    }","    ","    textarea:focus {","      outline: none;","    }","    ","    .d2-line {","      display: flex;","      padding: var(--space-xs) var(--space-md);","      border-bottom: 1px solid var(--border-subtle);","      cursor: pointer;","      transition: background var(--transition-fast);","    }","    ","    .d2-line:hover {","      background: var(--bg-overlay);","    }","    ","    .d2-line.highlighted {","      background: var(--bg-highlight);","    }","    ","    .d2-line.root {","      background: rgba(166, 227, 161, 0.1);","    }","    ","    .line-num {","      color: var(--text-muted);","      width: 3rem;","      flex-shrink: 0;","      user-select: none;","    }","    ","    .line-content {","      flex: 1;","      white-space: pre;","      overflow-x: auto;","    }","    ","    .pointer {","      color: var(--accent);","      cursor: pointer;","      text-decoration: underline;","    }","    ","    .pointer:hover {","      color: var(--accent-dim);","    }","    ","    .schema-ref { color: var(--info); }","    .string { color: var(--success); }","    .number { color: var(--warning); }","    .boolean { color: var(--accent2); }","    .null { color: var(--text-muted); }","    .key { color: var(--accent); }","    ","    .decoded-view {","      padding: var(--space-md);","      font-family: var(--font-mono);","      font-size: 0.875rem;","      white-space: pre-wrap;","      line-height: 1.6;","    }","    ","    .error {","      color: var(--error);","      padding: var(--space-md);","    }","  </style>","</head>","<body>","  <header class=\"app-header\">","    <a href=\"../\" class=\"home-link\" title=\"Back to App Launcher\">üè†</a>","    <div>","      <h1>D2 Playground</h1>","      <p class=\"subtitle\">JSONL format with pointer deduplication</p>","    </div>","    <div class=\"header-stats\">","      <div class=\"header-stat\">","        <span class=\"header-stat-value\" id=\"json-size\">0</span>","        <span class=\"header-stat-label\">JSON bytes</span>","      </div>","      <div class=\"header-stat\">","        <span class=\"header-stat-value\" id=\"d2-size\">0</span>","        <span class=\"header-stat-label\">D2 bytes</span>","      </div>","      <div class=\"header-stat\">","        <span class=\"header-stat-value\" id=\"savings\">0%</span>","        <span class=\"header-stat-label\">savings</span>","      </div>","      <div class=\"header-stat\">","        <span class=\"header-stat-value\" id=\"line-count\">0</span>","        <span class=\"header-stat-label\">lines</span>","      </div>","    </div>","  </header>","  ","  <main>","    <div class=\"panel\">","      <div class=\"panel-header\">","        <span class=\"panel-title\">JSON Input</span>","        <button class=\"btn btn-sm\" onclick=\"loadSample()\">Load Sample</button>","      </div>","      <div class=\"panel-body\">","        <textarea id=\"json-input\" placeholder=\"Enter JSON here...\">{","  \"name\": \"D2 Format\",","  \"version\": \"1.0\",","  \"features\": [","    {\"name\": \"Pointers\", \"type\": \"core\"},","    {\"name\": \"Schemas\", \"type\": \"core\"},","    {\"name\": \"Deduplication\", \"type\": \"optimization\"}","  ],","  \"metadata\": {","    \"author\": \"Tim Caswell\",","    \"type\": \"format\"","  }","}</textarea>","      </div>","    </div>","    ","    <div class=\"panel\">","      <div class=\"panel-header\">","        <span class=\"panel-title\">D2 Output</span>","        <div class=\"tabs\">","          <button class=\"tab active\" onclick=\"setView('lines')\">Lines</button>","          <button class=\"tab\" onclick=\"setView('raw')\">Raw</button>","        </div>","      </div>","      <div class=\"panel-body\">","        <div id=\"d2-output\"></div>","      </div>","    </div>","    ","    <div class=\"panel\">","      <div class=\"panel-header\">","        <span class=\"panel-title\">Decoded</span>","        <button class=\"btn btn-sm btn-ghost\" onclick=\"copyDecoded()\">Copy</button>","      </div>","      <div class=\"panel-body\">","        <div class=\"decoded-view\" id=\"decoded-output\"></div>","      </div>","    </div>","  </main>","","  <script>","    // D2 Encoder","    class D2Encoder {","      constructor() {","        this.lines = [];","        this.valueMap = new Map();","        this.schemaMap = new Map();","      }","      ","      encode(value) {","        this.lines = [];","        this.valueMap.clear();","        this.schemaMap.clear();","        const rootRef = this.encodeValue(value);","        return this.lines.map(l => JSON.stringify(l)).join('\\n');","      }","      ","      encodeValue(value) {","        const key = JSON.stringify(value);","        if (this.valueMap.has(key)) {","          return this.valueMap.get(key);","        }","        ","        let encoded;","        ","        if (value === null || typeof value !== 'object') {","          encoded = value;","        } else if (Array.isArray(value)) {","          encoded = value.map(v => this.encodeValue(v));","        } else {","          const keys = Object.keys(value);","          const schemaKey = keys.join(',');","          ","          let schemaLineNum;","          if (this.schemaMap.has(schemaKey)) {","            schemaLineNum = this.schemaMap.get(schemaKey);","          } else {","            this.lines.push(keys);","            schemaLineNum = this.lines.length;","            this.schemaMap.set(schemaKey, schemaLineNum);","          }","          ","          const values = keys.map(k => this.encodeValue(value[k]));","          encoded = [-schemaLineNum, ...values];","        }","        ","        this.lines.push(encoded);","        const lineNum = this.lines.length;","        this.valueMap.set(key, lineNum);","        return lineNum;","      }","      ","      getLines() {","        return this.lines;","      }","    }","    ","    // D2 Decoder","    class D2Decoder {","      constructor(lines) {","        this.lines = lines;","      }","      ","      decode() {","        if (this.lines.length === 0) return null;","        return this.resolveValue(this.lines.length);","      }","      ","      resolveValue(lineNum) {","        if (typeof lineNum !== 'number' || lineNum < 1 || lineNum > this.lines.length) {","          return lineNum;","        }","        ","        const value = this.lines[lineNum - 1];","        ","        if (value === null || typeof value !== 'object') {","          return value;","        }","        ","        if (Array.isArray(value)) {","          if (value.length > 0 && typeof value[0] === 'number' && value[0] < 0) {","            const schemaLineNum = -value[0];","            const schema = this.lines[schemaLineNum - 1];","            if (!Array.isArray(schema)) {","              throw new Error(`Invalid schema at line ${schemaLineNum}`);","            }","            ","            const obj = {};","            for (let i = 0; i < schema.length; i++) {","              obj[schema[i]] = this.resolveValue(value[i + 1]);","            }","            return obj;","          }","          ","          return value.map(v => this.resolveValue(v));","        }","        ","        return value;","      }","    }","    ","    // UI State","    let currentView = 'lines';","    let currentLines = [];","    let highlightedLine = null;","    ","    function update() {","      const input = document.getElementById('json-input').value;","      const outputEl = document.getElementById('d2-output');","      const decodedEl = document.getElementById('decoded-output');","      ","      try {","        const json = JSON.parse(input);","        ","        const encoder = new D2Encoder();","        const d2Output = encoder.encode(json);","        currentLines = encoder.getLines();","        ","        const decoder = new D2Decoder(currentLines);","        const decoded = decoder.decode();","        ","        const jsonSize = input.length;","        const d2Size = d2Output.length;","        document.getElementById('json-size').textContent = jsonSize;","        document.getElementById('d2-size').textContent = d2Size;","        document.getElementById('line-count').textContent = currentLines.length;","        ","        const savings = ((1 - d2Size / jsonSize) * 100).toFixed(1);","        document.getElementById('savings').textContent = ","          (savings > 0 ? '+' : '') + savings + '%';","        ","        renderOutput(currentLines);","        decodedEl.textContent = JSON.stringify(decoded, null, 2);","        ","      } catch (e) {","        outputEl.innerHTML = `<div class=\"error\">Error: ${e.message}</div>`;","        decodedEl.textContent = '';","      }","    }","    ","    function renderOutput(lines) {","      const outputEl = document.getElementById('d2-output');","      ","      if (currentView === 'raw') {","        outputEl.innerHTML = `<textarea readonly style=\"width:100%;height:100%;background:var(--bg-base);color:var(--text);border:none;padding:1rem;font-family:var(--font-mono);\">${lines.map(l => JSON.stringify(l)).join('\\n')}</textarea>`;","        return;","      }","      ","      let html = '';","      lines.forEach((line, idx) => {","        const lineNum = idx + 1;","        const isRoot = lineNum === lines.length;","        const isHighlighted = lineNum === highlightedLine;","        ","        let classes = 'd2-line';","        if (isRoot) classes += ' root';","        if (isHighlighted) classes += ' highlighted';","        ","        const content = formatLine(line, lineNum);","        ","        html += `<div class=\"${classes}\" data-line=\"${lineNum}\" onclick=\"highlightLine(${lineNum})\">","          <span class=\"line-num\">${lineNum}</span>","          <span class=\"line-content\">${content}</span>","        </div>`;","      });","      ","      outputEl.innerHTML = html;","    }","    ","    function formatLine(value, currentLine) {","      if (value === null) return '<span class=\"null\">null</span>';","      if (typeof value === 'string') return `<span class=\"string\">\"${escapeHtml(value)}\"</span>`;","      if (typeof value === 'number') return `<span class=\"number\">${value}</span>`;","      if (typeof value === 'boolean') return `<span class=\"boolean\">${value}</span>`;","      ","      if (Array.isArray(value)) {","        if (value.length > 0 && typeof value[0] === 'number' && value[0] < 0) {","          const schemaRef = -value[0];","          const parts = [`<span class=\"schema-ref\">${value[0]}</span>`];","          for (let i = 1; i < value.length; i++) {","            parts.push(formatPointerOrValue(value[i]));","          }","          return '[' + parts.join(', ') + ']';","        }","        ","        if (value.every(v => typeof v === 'string')) {","          return '[' + value.map(v => `<span class=\"key\">\"${escapeHtml(v)}\"</span>`).join(', ') + ']';","        }","        ","        return '[' + value.map(v => formatPointerOrValue(v)).join(', ') + ']';","      }","      ","      return JSON.stringify(value);","    }","    ","    function formatPointerOrValue(value) {","      if (typeof value === 'number' && value > 0 && Number.isInteger(value) && value <= currentLines.length) {","        return `<span class=\"pointer\" onclick=\"event.stopPropagation(); highlightLine(${value})\">${value}</span>`;","      }","      if (value === null) return '<span class=\"null\">null</span>';","      if (typeof value === 'string') return `<span class=\"string\">\"${escapeHtml(value)}\"</span>`;","      if (typeof value === 'number') return `<span class=\"number\">${value}</span>`;","      if (typeof value === 'boolean') return `<span class=\"boolean\">${value}</span>`;","      return JSON.stringify(value);","    }","    ","    function escapeHtml(str) {","      return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');","    }","    ","    function highlightLine(lineNum) {","      highlightedLine = lineNum;","      renderOutput(currentLines);","      ","      const lineEl = document.querySelector(`[data-line=\"${lineNum}\"]`);","      if (lineEl) {","        lineEl.scrollIntoView({ behavior: 'smooth', block: 'center' });","      }","    }","    ","    function setView(view) {","      currentView = view;","      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));","      event.target.classList.add('active');","      renderOutput(currentLines);","    }","    ","    function copyDecoded() {","      const text = document.getElementById('decoded-output').textContent;","      navigator.clipboard.writeText(text);","    }","    ","    function loadSample() {","      document.getElementById('json-input').value = JSON.stringify({","        \"users\": [","          {\"id\": 1, \"name\": \"Alice\", \"role\": \"admin\", \"active\": true},","          {\"id\": 2, \"name\": \"Bob\", \"role\": \"user\", \"active\": true},","          {\"id\": 3, \"name\": \"Charlie\", \"role\": \"user\", \"active\": false}","        ],","        \"config\": {","          \"version\": \"2.0\",","          \"features\": [\"auth\", \"api\", \"dashboard\"],","          \"settings\": {","            \"theme\": \"dark\",","            \"language\": \"en\"","          }","        },","        \"metadata\": {","          \"created\": \"2024-01-15\",","          \"modified\": \"2024-01-20\"","        }","      }, null, 2);","      update();","    }","    ","    document.getElementById('json-input').addEventListener('input', update);","    update();","  </script>","  <script src=\"../demo-runner.js\"></script>","</body>","</html>",""]}