{"type":"text","lines":["<!DOCTYPE html>","<html lang=\"en\">","<head>","  <meta charset=\"UTF-8\">","  <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">","  <title>Nibs Playground</title>","  <link rel=\"stylesheet\" href=\"../shared/theme.css\">","  <link rel=\"stylesheet\" href=\"../shared/widgets.css\">","  <style>","    /* App layout */","    body {","      height: 100vh;","      display: flex;","      flex-direction: column;","      overflow: hidden;","    }","    ","    /* App-specific: Hex view and type colors */","    .hex-view { font-family: var(--font-mono); }","    ","    .hex-row {","      display: flex;","      gap: 8px;","      padding: 2px 0;","    }","    ","    .hex-offset {","      color: var(--text-dim);","      min-width: 48px;","    }","    ","    .hex-bytes {","      display: flex;","      gap: 4px;","      flex-wrap: wrap;","    }","    ","    .hex-byte {","      padding: 1px 3px;","      border-radius: 2px;","    }","    ","    .hex-ascii {","      color: var(--text-dim);","      margin-left: 16px;","    }","    ","    /* Type colors */","    .t-zigzag { background: rgba(250, 179, 135, 0.2); color: #fab387; }","    .t-float { background: rgba(249, 226, 175, 0.2); color: #f9e2af; }","    .t-simple { background: rgba(245, 194, 231, 0.2); color: var(--accent2); }","    .t-utf8 { background: rgba(166, 227, 161, 0.2); color: var(--success); }","    .t-list { background: rgba(137, 180, 250, 0.2); color: var(--accent); }","    .t-map { background: rgba(148, 226, 213, 0.2); color: #94e2d5; }","    .t-content { background: transparent; color: var(--text); }","    ","    /* Tree view */","    .tree-node { padding: 2px 0; }","    ","    .tree-type {","      display: inline-block;","      padding: 1px 6px;","      border-radius: 3px;","      font-size: 11px;","      margin-right: 8px;","    }","    ","    .tree-value { color: var(--text); }","    .tree-key { color: var(--accent); }","    .tree-children { margin-left: 20px; border-left: 1px solid var(--border); padding-left: 12px; }","  </style>","</head>","<body>","  <header class=\"app-header\">","    <a href=\"../\" class=\"home-link\" title=\"Back to App Launcher\">üè†</a>","    <h1>üî¢ Nibs Playground</h1>","    <div class=\"stats\" id=\"stats\">Enter JSON to encode</div>","  </header>","  ","  <main class=\"editor-container\">","    <div class=\"editor-panel\">","      <div class=\"panel-header\">","        JSON Input","        <span class=\"bytes\" id=\"json-bytes\">0 bytes</span>","      </div>","      <div class=\"panel-content\">","        <textarea id=\"input\" class=\"editor-textarea\" placeholder=\"Enter JSON here...\">{","  \"name\": \"Nibs\",","  \"type\": \"binary\",","  \"features\": [\"compact\", \"random-access\"],","  \"numbers\": [1, -2, 3.14, 1000000],","  \"nested\": {\"enabled\": true, \"count\": 42}","}</textarea>","      </div>","    </div>","    ","    <div class=\"editor-panel\">","      <div class=\"tabs\">","        <button class=\"tab active\" onclick=\"showTab('hex')\">Hex View</button>","        <button class=\"tab\" onclick=\"showTab('tree')\">Tree View</button>","        <button class=\"tab\" onclick=\"showTab('decoded')\">Decoded</button>","      </div>","      <div class=\"panel-header\">","        <span id=\"output-label\">Binary Output</span>","        <span class=\"bytes\" id=\"nibs-bytes\">0 bytes</span>","      </div>","      <div class=\"panel-content\">","        <div class=\"output\" id=\"output\"></div>","      </div>","    </div>","  </main>","","  <script>","    // Nibs encoder/decoder (simplified implementation)","    // Type codes","    const ZIGZAG = 0;","    const FLOAT = 1;","    const SIMPLE = 2;","    const UTF8 = 9;","    const LIST = 0xB;","    const MAP = 0xC;","    ","    // Simple values","    const FALSE = 0;","    const TRUE = 1;","    const NULL = 2;","    ","    // Encode integer pair (type, value)","    function encodePair(type, val) {","      if (val < 12) {","        return [((val + 4) << 4) | type];","      } else if (val < 0x100) {","        return [type, val];","      } else if (val < 0x10000) {","        return [0x10 | type, val >> 8, val & 0xFF];","      } else if (val < 0x100000000) {","        return [0x20 | type, val >> 24, (val >> 16) & 0xFF, (val >> 8) & 0xFF, val & 0xFF];","      } else {","        // 64-bit (simplified - just use 32-bit for now)","        return [0x20 | type, val >> 24, (val >> 16) & 0xFF, (val >> 8) & 0xFF, val & 0xFF];","      }","    }","    ","    // Decode integer pair","    function decodePair(data, offset) {","      const byte = data[offset];","      const type = byte & 0xF;","      const small = byte >> 4;","      ","      if (small >= 4) {","        return { type, val: small - 4, size: 1 };","      } else if (small === 0) {","        return { type, val: data[offset + 1], size: 2 };","      } else if (small === 1) {","        return { type, val: (data[offset + 1] << 8) | data[offset + 2], size: 3 };","      } else if (small === 2) {","        return { type, val: (data[offset + 1] << 24) | (data[offset + 2] << 16) | (data[offset + 3] << 8) | data[offset + 4], size: 5 };","      }","      throw new Error('64-bit not fully supported');","    }","    ","    // ZigZag encoding for signed integers","    function zigzagEncode(n) {","      return n >= 0 ? n * 2 : (-n * 2) - 1;","    }","    ","    function zigzagDecode(n) {","      return (n & 1) ? -((n + 1) >> 1) : n >> 1;","    }","    ","    // Encode any value","    function encodeAny(val, metadata = []) {","      if (val === null) {","        const bytes = encodePair(SIMPLE, NULL);","        metadata.push({ offset: 0, len: bytes.length, type: 'simple', desc: 'null' });","        return bytes;","      }","      if (val === true) {","        const bytes = encodePair(SIMPLE, TRUE);","        metadata.push({ offset: 0, len: bytes.length, type: 'simple', desc: 'true' });","        return bytes;","      }","      if (val === false) {","        const bytes = encodePair(SIMPLE, FALSE);","        metadata.push({ offset: 0, len: bytes.length, type: 'simple', desc: 'false' });","        return bytes;","      }","      if (typeof val === 'number') {","        if (Number.isInteger(val) && val >= -2147483648 && val <= 2147483647) {","          const bytes = encodePair(ZIGZAG, zigzagEncode(val));","          metadata.push({ offset: 0, len: bytes.length, type: 'zigzag', desc: `int ${val}` });","          return bytes;","        } else {","          // Float64","          const buf = new ArrayBuffer(8);","          new DataView(buf).setFloat64(0, val, false);","          const floatBytes = [...new Uint8Array(buf)];","          const header = encodePair(FLOAT, 8);","          const bytes = [...header, ...floatBytes];","          metadata.push({ offset: 0, len: header.length, type: 'float', desc: `float ${val}` });","          metadata.push({ offset: header.length, len: 8, type: 'content', desc: 'float data' });","          return bytes;","        }","      }","      if (typeof val === 'string') {","        const utf8 = new TextEncoder().encode(val);","        const header = encodePair(UTF8, utf8.length);","        const bytes = [...header, ...utf8];","        metadata.push({ offset: 0, len: header.length, type: 'utf8', desc: `string len=${utf8.length}` });","        metadata.push({ offset: header.length, len: utf8.length, type: 'content', desc: `\"${val}\"` });","        return bytes;","      }","      if (Array.isArray(val)) {","        const elements = val.map(v => encodeAny(v, []));","        const content = elements.flat();","        const header = encodePair(LIST, content.length);","        const bytes = [...header, ...content];","        metadata.push({ offset: 0, len: header.length, type: 'list', desc: `list len=${content.length}` });","        return bytes;","      }","      if (typeof val === 'object') {","        const entries = Object.entries(val);","        const content = entries.flatMap(([k, v]) => [...encodeAny(k, []), ...encodeAny(v, [])]);","        const header = encodePair(MAP, content.length);","        const bytes = [...header, ...content];","        metadata.push({ offset: 0, len: header.length, type: 'map', desc: `map len=${content.length}` });","        return bytes;","      }","      throw new Error(`Unsupported type: ${typeof val}`);","    }","    ","    // Decode any value","    function decodeAny(data, offset) {","      const { type, val, size } = decodePair(data, offset);","      let pos = offset + size;","      ","      if (type === SIMPLE) {","        if (val === NULL) return { value: null, offset: pos };","        if (val === TRUE) return { value: true, offset: pos };","        if (val === FALSE) return { value: false, offset: pos };","      }","      if (type === ZIGZAG) {","        return { value: zigzagDecode(val), offset: pos };","      }","      if (type === FLOAT) {","        const buf = new Uint8Array(data.slice(pos, pos + val)).buffer;","        const value = new DataView(buf).getFloat64(0, false);","        return { value, offset: pos + val };","      }","      if (type === UTF8) {","        const value = new TextDecoder().decode(new Uint8Array(data.slice(pos, pos + val)));","        return { value, offset: pos + val };","      }","      if (type === LIST) {","        const list = [];","        const end = pos + val;","        while (pos < end) {","          const { value, offset: newPos } = decodeAny(data, pos);","          list.push(value);","          pos = newPos;","        }","        return { value: list, offset: pos };","      }","      if (type === MAP) {","        const obj = {};","        const end = pos + val;","        while (pos < end) {","          const { value: key, offset: pos2 } = decodeAny(data, pos);","          const { value, offset: pos3 } = decodeAny(data, pos2);","          obj[key] = value;","          pos = pos3;","        }","        return { value: obj, offset: pos };","      }","      throw new Error(`Unknown type: ${type}`);","    }","    ","    function encode(val) {","      return new Uint8Array(encodeAny(val, []));","    }","    ","    function decode(data) {","      const { value } = decodeAny([...data], 0);","      return value;","    }","    ","    // UI","    let currentTab = 'hex';","    let encodedBytes = new Uint8Array();","    let decodedOutput = '';","    let treeData = null;","    ","    const typeNames = {","      [ZIGZAG]: 'ZIGZAG',","      [FLOAT]: 'FLOAT',","      [SIMPLE]: 'SIMPLE',","      [UTF8]: 'UTF8',","      [LIST]: 'LIST',","      [MAP]: 'MAP'","    };","    ","    const typeColors = {","      [ZIGZAG]: 't-zigzag',","      [FLOAT]: 't-float',","      [SIMPLE]: 't-simple',","      [UTF8]: 't-utf8',","      [LIST]: 't-list',","      [MAP]: 't-map'","    };","    ","    function buildTree(data, offset, depth = 0) {","      const { type, val, size } = decodePair(data, offset);","      let pos = offset + size;","      const node = { type, typeName: typeNames[type], offset, headerSize: size };","      ","      if (type === SIMPLE) {","        node.value = val === NULL ? null : val === TRUE;","        node.display = String(node.value);","        return { node, offset: pos };","      }","      if (type === ZIGZAG) {","        node.value = zigzagDecode(val);","        node.display = String(node.value);","        return { node, offset: pos };","      }","      if (type === FLOAT) {","        const buf = new Uint8Array(data.slice(pos, pos + val)).buffer;","        node.value = new DataView(buf).getFloat64(0, false);","        node.display = String(node.value);","        return { node, offset: pos + val };","      }","      if (type === UTF8) {","        node.value = new TextDecoder().decode(new Uint8Array(data.slice(pos, pos + val)));","        node.display = `\"${node.value}\"`;","        return { node, offset: pos + val };","      }","      if (type === LIST) {","        node.children = [];","        const end = pos + val;","        while (pos < end) {","          const { node: child, offset: newPos } = buildTree(data, pos, depth + 1);","          node.children.push(child);","          pos = newPos;","        }","        node.display = `[${node.children.length} items]`;","        return { node, offset: pos };","      }","      if (type === MAP) {","        node.children = [];","        const end = pos + val;","        while (pos < end) {","          const { node: keyNode, offset: pos2 } = buildTree(data, pos, depth + 1);","          const { node: valNode, offset: pos3 } = buildTree(data, pos2, depth + 1);","          node.children.push({ key: keyNode, value: valNode });","          pos = pos3;","        }","        node.display = `{${node.children.length} pairs}`;","        return { node, offset: pos };","      }","      return { node, offset: pos };","    }","    ","    function renderTree(node, indent = 0) {","      const colorClass = typeColors[node.type] || '';","      let html = `<div class=\"tree-node\">`;","      html += `<span class=\"tree-type ${colorClass}\">${node.typeName}</span>`;","      ","      if (node.children && node.type === LIST) {","        html += `<span class=\"tree-value\">${node.display}</span>`;","        html += `<div class=\"tree-children\">`;","        for (let i = 0; i < node.children.length; i++) {","          html += `<div>[${i}] ${renderTree(node.children[i])}</div>`;","        }","        html += `</div>`;","      } else if (node.children && node.type === MAP) {","        html += `<span class=\"tree-value\">${node.display}</span>`;","        html += `<div class=\"tree-children\">`;","        for (const { key, value } of node.children) {","          html += `<div><span class=\"tree-key\">${key.display}</span>: ${renderTree(value)}</div>`;","        }","        html += `</div>`;","      } else {","        html += `<span class=\"tree-value\">${node.display}</span>`;","      }","      html += `</div>`;","      return html;","    }","    ","    function renderHex(data) {","      const rows = [];","      for (let i = 0; i < data.length; i += 16) {","        const chunk = data.slice(i, i + 16);","        const hexBytes = [...chunk].map((b, j) => {","          const { type } = decodePair(data, i + j);","          const colorClass = typeColors[type] || 't-content';","          return `<span class=\"hex-byte ${colorClass}\">${b.toString(16).padStart(2, '0')}</span>`;","        }).join('');","        ","        const ascii = [...chunk].map(b => ","          b >= 32 && b < 127 ? String.fromCharCode(b) : '.'","        ).join('');","        ","        rows.push(`<div class=\"hex-row\">","          <span class=\"hex-offset\">${i.toString(16).padStart(4, '0')}</span>","          <span class=\"hex-bytes\">${hexBytes}</span>","          <span class=\"hex-ascii\">${ascii}</span>","        </div>`);","      }","      return `<div class=\"hex-view\">${rows.join('')}</div>`;","    }","    ","    window.showTab = function(tab) {","      currentTab = tab;","      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));","      event.target.classList.add('active');","      updateOutput();","    }","    ","    function updateOutput() {","      const outputEl = document.getElementById('output');","      const labelEl = document.getElementById('output-label');","      ","      if (currentTab === 'hex') {","        outputEl.innerHTML = renderHex(encodedBytes);","        labelEl.textContent = 'Hex View';","      } else if (currentTab === 'tree') {","        if (treeData) {","          outputEl.innerHTML = renderTree(treeData);","        } else {","          outputEl.innerHTML = '<span style=\"color: var(--text-dim)\">No data</span>';","        }","        labelEl.textContent = 'Tree View';","      } else {","        outputEl.className = 'output';","        outputEl.textContent = decodedOutput;","        labelEl.textContent = 'Decoded JSON';","      }","    }","    ","    function encodeInput() {","      const input = document.getElementById('input').value;","      const statsEl = document.getElementById('stats');","      const jsonBytesEl = document.getElementById('json-bytes');","      const nibsBytesEl = document.getElementById('nibs-bytes');","      const outputEl = document.getElementById('output');","      ","      try {","        const data = JSON.parse(input);","        const jsonBytes = new TextEncoder().encode(input).length;","        encodedBytes = encode(data);","        ","        // Build tree","        const { node } = buildTree([...encodedBytes], 0);","        treeData = node;","        ","        // Decode to verify","        const decoded = decode(encodedBytes);","        decodedOutput = JSON.stringify(decoded, null, 2);","        ","        jsonBytesEl.textContent = `${jsonBytes} bytes`;","        nibsBytesEl.textContent = `${encodedBytes.length} bytes`;","        ","        const savings = ((jsonBytes - encodedBytes.length) / jsonBytes * 100).toFixed(1);","        statsEl.innerHTML = `Savings: <span class=\"saving\">${savings}%</span> (${jsonBytes - encodedBytes.length} bytes)`;","        ","        updateOutput();","      } catch (e) {","        outputEl.className = 'output error';","        outputEl.textContent = `Error: ${e.message}`;","        statsEl.textContent = 'Invalid input';","      }","    }","    ","    document.getElementById('input').addEventListener('input', encodeInput);","    encodeInput();","  </script>","  <script src=\"../demo-runner.js\"></script>","</body>","</html>",""]}